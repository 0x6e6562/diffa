<!--

    Copyright (C) 2010-2011 LShift Ltd.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <link rel="stylesheet" href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" type="text/css" media="screen" />
  <script>
    include("jquery-1.4.2.js");
    include("json2.js"); // from json.org; in public domain
    include("diffa-rest.js"); // wrappers for AJAX rest calls; depends on jquery & json2
    $(document).ready(function() {

var _handle_errors_globally = true;
function with_no_error_handling(x) {
    _handle_errors_globally = false;
    x();
    _handle_errors_globally = true;
}

function deepEqualFunc(expected) {
    return function(result) {deepEqual(result, expected)};
}

$.ajaxSetup({
    async: false
});

$(document).ajaxError(function(event, xhr, settings, ex) {
    if (_handle_errors_globally)
        ok(false, "AJAX error while running tests! " + xhr.status + ": " + xhr.responseText);
});

const CFG_URL = 'http://localhost:19093/diffa-agent/rest/config/';

test("crud_all", function() {
    const group_def = {key: "TEST_group"};
    const upstream_def = {name: "TEST_upstream", url: "http://127.0.0.1/1", online: false, contentType: "application/json", inboundUrl: null, categories: {}};
    const downstream_def = {name: "TEST_downstream", url: "http://127.0.0.1/2", online: false, contentType: "application/json", inboundUrl: null, categories: {}};
    const pair_def = {
        pairKey: "TEST_pair",
        versionPolicyName: "same",
        matchingTimeout: 0,
        upstreamName: upstream_def.name,
        downstreamName: downstream_def.name,
        groupKey: group_def.key
    };
    const expected_pair_def = {
        key: pair_def.pairKey,
        upstream: upstream_def,
        downstream: downstream_def,
        group: group_def,
        versionPolicyName: pair_def.versionPolicyName,
        matchingTimeout: pair_def.matchingTimeout
    };

    const not_exists_handler = {error: function(xhr, statusText, error) {equal(xhr.status, 404)}};

    // Test creating a group
    fd_create(CFG_URL, 'groups', group_def);
    fd_get(CFG_URL, 'groups', group_def.key, deepEqualFunc(group_def));

    // Test creating endpoints
    fd_create(CFG_URL, 'endpoints', upstream_def);
    fd_create(CFG_URL, 'endpoints', downstream_def);
    fd_get(CFG_URL, 'endpoints', upstream_def.name, deepEqualFunc(upstream_def));
    fd_get(CFG_URL, 'endpoints', downstream_def.name, deepEqualFunc(downstream_def));

    // Test creating a pair
//    fd_create(CFG_URL, 'pairs', pair_def);
//    fd_get(CFG_URL, 'pairs', pair_def.pairKey, deepEqualFunc(expected_pair_def));
//
//    // Delete the test group and check its and its pairs' nonexistence
//    fd_delete(CFG_URL, 'groups', group_def.key);
//    with_no_error_handling(function() {
//        fd_get(CFG_URL, 'groups', group_def.key,
//            function() {ok(false, "Deleted group shouldn't exist.")},
//            not_exists_handler);
//        fd_get(CFG_URL, 'pairs', pair_def.pairKey,
//            function() {ok(false, "Pair shouldn't exist after group deletion.")},
//            not_exists_handler);
//    });

    // Delete endpoints
    fd_delete(CFG_URL, 'endpoints', upstream_def.name);
    fd_delete(CFG_URL, 'endpoints', downstream_def.name);
    with_no_error_handling(function() {
        fd_get(CFG_URL, 'endpoints', upstream_def.name,
            function() {ok(false, "Deleted upstream endpoint shouldn't exist.")},
            not_exists_handler);
        fd_get(CFG_URL, 'endpoints', downstream_def.name,
            function() {ok(false, "Deleted downstream endpoint shouldn't exist.")},
            not_exists_handler);
    });                                             
});

  }); // $(document).ready(...)
  </script>
</head>
<body>
  <h1 id="qunit-header"></h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
 <div id="qunit-fixture"></div>
 <div id="qunit-testresult"></div>
</body>
</html>
